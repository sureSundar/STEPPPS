#!/bin/bash
# TernaryBit OS Complete Bootloader to Shell Demo
# üïâÔ∏è Swamiye Saranam Aiyappa üïâÔ∏è

set -euo pipefail

echo "=============================================="
echo "  TernaryBit OS - Bootloader to Shell Demo"
echo "  STEPPPS Framework Complete Implementation"
echo "=============================================="
echo ""

cd "$(dirname "$0")"

# Check if build exists
if [ ! -f "build/tbos_universal.img" ]; then
    echo "‚ö†Ô∏è  Build not found. Building now..."
    echo ""
    ./build_universal.sh
    echo ""
fi

echo "‚úÖ Build complete!"
echo ""
echo "üìä Build Statistics:"
echo "-------------------"
ls -lh build/boot.bin build/stage2.bin build/kernel.bin 2>/dev/null | awk '{print "  " $9 ": " $5}'
echo ""

echo "üîç Verifying Boot Sector Signature..."
BOOT_SIG=$(xxd -s 510 -l 2 -p build/boot.bin)
if [ "$BOOT_SIG" = "55aa" ]; then
    echo "  ‚úÖ Boot signature valid (0x55AA)"
else
    echo "  ‚ùå Boot signature invalid: $BOOT_SIG"
    exit 1
fi
echo ""

echo "üìã System Architecture:"
echo "----------------------"
echo "  ‚Ä¢ Real Mode Boot (BIOS)"
echo "  ‚Ä¢ Stage 1: MBR (512 bytes)"
echo "  ‚Ä¢ Stage 2: Long Mode Transition (16‚Üí32‚Üí64 bit)"
echo "  ‚Ä¢ Kernel: 64-bit Long Mode"
echo "  ‚Ä¢ Shell: Interactive command processor"
echo ""

echo "üéØ Boot Flow:"
echo "-------------"
echo "  BIOS ‚Üí Stage 1 (MBR) ‚Üí Stage 2 (Long Mode)"
echo "    ‚Üì"
echo "  64-bit Kernel ‚Üí IDT ‚Üí Interrupts ‚Üí Keyboard"
echo "    ‚Üì"
echo "  Interactive Shell ‚Üí Commands ‚Üí READY!"
echo ""

echo "üíª Available Shell Commands:"
echo "---------------------------"
echo "  ‚Ä¢ help      - Show all commands"
echo "  ‚Ä¢ calc      - Calculator (e.g., calc 2+2)"
echo "  ‚Ä¢ steppps   - STEPPPS framework status"
echo "  ‚Ä¢ about     - OS information"
echo "  ‚Ä¢ echo      - Print text"
echo "  ‚Ä¢ clear/cls - Clear screen"
echo "  ‚Ä¢ test      - Run system tests"
echo "  ‚Ä¢ om        - Sacred mantra"
echo "  ‚Ä¢ reboot    - Restart system"
echo ""

echo "üöÄ Boot Options:"
echo "---------------"
echo "  [1] Boot in QEMU with GUI"
echo "  [2] Boot in QEMU headless (serial output)"
echo "  [3] Show disk image info"
echo "  [4] Exit"
echo ""

read -p "Select option [1-4]: " choice

case $choice in
    1)
        echo ""
        echo "üéÆ Starting QEMU with GUI..."
        echo ""
        echo "Instructions:"
        echo "  ‚Ä¢ Type commands in the QEMU window"
        echo "  ‚Ä¢ Press Ctrl+Alt+2 for QEMU monitor"
        echo "  ‚Ä¢ Press Ctrl+Alt+Q to quit"
        echo ""
        sleep 2

        qemu-system-x86_64 \
            -drive file=build/tbos_universal.img,format=raw \
            -m 512 \
            -name "TernaryBit OS"
        ;;

    2)
        echo ""
        echo "üì° Starting QEMU in headless mode..."
        echo "    (Serial output to console)"
        echo ""

        timeout 5 qemu-system-x86_64 \
            -drive file=build/tbos_universal.img,format=raw \
            -m 512 \
            -nographic \
            -serial mon:stdio || echo ""

        echo ""
        echo "‚è±Ô∏è  Demo timed out (5 seconds)"
        ;;

    3)
        echo ""
        echo "üíæ Disk Image Information:"
        echo "-------------------------"
        file build/tbos_universal.img
        echo ""
        echo "Sector Layout:"
        echo "  Sector 0:      Boot sector (512 bytes)"
        echo "  Sectors 1-9:   Stage 2 bootloader"
        echo "  Sectors 10+:   Kernel binary"
        echo ""
        echo "First 32 bytes of boot sector:"
        xxd -l 32 build/tbos_universal.img
        echo ""
        echo "Last 2 bytes (boot signature):"
        xxd -s 510 -l 2 build/tbos_universal.img
        ;;

    4)
        echo ""
        echo "üëã Exiting..."
        exit 0
        ;;

    *)
        echo ""
        echo "‚ùå Invalid option"
        exit 1
        ;;
esac

echo ""
echo "‚úÖ Demo complete!"
echo ""
echo "üìö Documentation:"
echo "----------------"
echo "  ‚Ä¢ README_BOOT_TO_SHELL.md - Quick start guide"
echo "  ‚Ä¢ BOOT_TO_SHELL_GUIDE.md  - Technical deep-dive"
echo "  ‚Ä¢ TESTING_GUIDE.md        - Testing & troubleshooting"
echo ""
echo "üïâÔ∏è Swamiye Saranam Aiyappa üïâÔ∏è"
