# x86_64 Architecture Guide

## Boot Process

### BIOS Boot
1. Power On Self Test (POST)
2. BIOS loads first sector (MBR) to 0x7C00
3. Bootloader stage 1 executes
4. Loads stage 2 bootloader
5. Enables protected mode
6. Jumps to kernel entry point

### UEFI Boot
1. UEFI firmware initializes hardware
2. Loads EFI bootloader
3. Bootloader loads kernel
4. Handles 64-bit mode transition

## Memory Layout

### Physical Memory
```
0x00000000 - 0x0009FFFF: Real Mode Area (640KB)
0x000A0000 - 0x000FFFFF: Legacy Video/BIOS (384KB)
0x00100000 - 0x00EFFFFF: Kernel (14MB)
0x01000000 - 0x0FFFFFFF: Kernel Heap (240MB)
0x10000000 - 0x7FFFFFFF: User Space (1.75GB)
0x80000000 - 0xFFFFFFFF: Memory Mapped I/O (2GB)
```

### Virtual Memory
- 4-level paging (48-bit address space)
- Page size: 4KB (default), 2MB, 1GB
- Kernel at higher half (0xFFFFFFFF80000000)

## CPU Features

### Required Features
- Long mode (64-bit)
- Page Size Extension (PSE)
- Page Global Enable (PGE)
- FXSAVE/FXRSTOR
- System Call Extensions (SCE)

### Optional Optimizations
- SSE/SSE2/SSE3/SSE4
- AVX/AVX2
- AES-NI
- RDRAND/RDSEED

## Interrupts and Exceptions

### IDT Layout
- 0-31: CPU Exceptions
- 32-47: IRQs (PIC/IOAPIC)
- 48-255: Software Interrupts/Syscalls

### APIC/IOAPIC
- Local APIC for CPU-local interrupts
- I/O APIC for I/O device interrupts
- MSI/MSI-X support

## I/O Ports

### Standard Ports
- 0x3F8: COM1
- 0x60: PS/2 Keyboard
- 0x64: PS/2 Controller
- 0x1F0: Primary ATA
- 0x3F0: Floppy Controller

## ACPI
- RSDP detection
- ACPI tables parsing
- Power management
- CPU power states (C-states)
- Performance states (P-states)

## SMP Support
- BSP/AP initialization
- IPI (Inter-Processor Interrupts)
- CPU topology detection
- Load balancing

## Performance Considerations
- TLB shootdown handling
- Cache coherency
- Memory barriers
- NUMA awareness

## Debugging

### QEMU
```bash
qemu-system-x86_64 -s -S -kernel tbos.elf
```

### GDB Commands
```
target remote localhost:1234
layout asm
layout regs
break *0x100000
continue
```

## Common Issues
- Triple fault on invalid TSS
- Page fault in interrupt handler
- Stack alignment issues
- IRQ routing problems

## Optimization Tips
- Use huge pages when possible
- Align critical structures to cache lines
- Prefer rep movs/stos for large memory operations
- Use SSE/AVX for SIMD operations

## Testing

### QEMU
```bash
# Basic boot test
qemu-system-x86_64 -kernel tbos.elf -serial stdio

# With debug output
qemu-system-x86_64 -d int -no-reboot -kernel tbos.elf
```

### Hardware Testing
- Test on multiple chipsets
- Verify ACPI table parsing
- Check power management states
- Test interrupt routing

## References
- Intel 64 and IA-32 Architectures Software Developer's Manual
- AMD64 Architecture Programmer's Manual
- ACPI Specification
- UEFI Specification
